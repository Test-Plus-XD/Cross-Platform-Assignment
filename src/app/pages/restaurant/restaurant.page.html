<!-- Restaurant detail page: 6 equal cells -->
<ion-header translucent>
  <br>
  <ion-toolbar style="position: sticky; padding-top: 20px;">
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/search"></ion-back-button>
    </ion-buttons>
    <ion-title>
      {{ (lang$ | async) === 'TC' ? (restaurant?.Name_TC ?? '-') : (restaurant?.Name_EN ?? '-') }}
    </ion-title>
  </ion-toolbar>
</ion-header>

<ion-content fullscreen>
  <!-- Hero image and centred name -->
  <ion-grid class="hero-grid ion-no-padding">
    <ion-row class="image-row">
      <ion-col size="12" class="image-col">
        <img [src]="imageUrlOrPlaceholder()"
             alt="{{ (lang$ | async) === 'TC' ? (restaurant?.Name_TC ?? '-') : (restaurant?.Name_EN ?? '-') }}"
             class="restaurant-image" />
        <div class="name-overlay">
          <h1>{{ (lang$ | async) === 'TC' ? (restaurant?.Name_TC ?? '-') : (restaurant?.Name_EN ?? '-') }}</h1>
          <!-- Distance badge shown on hero image -->
          <ion-badge *ngIf="distanceResult" [color]="getDistanceColour()" class="distance-badge">
            <ion-icon name="location-outline"></ion-icon>
            {{ distanceResult.displayText }}
          </ion-badge>
        </div>
      </ion-col>
    </ion-row>
  </ion-grid>

  <!-- Info grid: Six equal cells (responsive) -->
  <ion-grid class="info-grid ion-no-padding">
    <ion-row class="cells-row">
      <!-- 1 Information: Address, District, Opening Hours, Seats -->
      <ion-col class="cell no-border" size="12" size-md="4">
        <div class="cell-title">
          <ion-icon name="information-circle-outline"></ion-icon>
          &nbsp;{{ (lang$ | async) === 'TC' ? '資訊' : 'Information' }}
        </div>
        <div class="cell-content small">
          <div class="muted">{{ (lang$ | async) === 'TC' ? '地址' : 'Address' }}</div>
          <div>{{ (lang$ | async) === 'TC' ? (restaurant?.Address_TC ?? '-') : (restaurant?.Address_EN ?? '-') }}</div>
          <div class="muted">{{ (lang$ | async) === 'TC' ? '地區' : 'District' }}</div>
          <div>{{ (lang$ | async) === 'TC' ? (restaurant?.District_TC ?? '-') : (restaurant?.District_EN ?? '-') }}</div>

          <div class="mt-1 font-medium">{{ (lang$ | async) === 'TC' ? '開放時間' : 'Opening Hours' }}</div>
          <div *ngIf="restaurant?.Opening_Hours; else noHours">
            <div *ngFor="let pair of (restaurant?.Opening_Hours | keyvalue)">
              {{ pair.key }}: {{ pair.value ?? '-' }}
            </div>
          </div>
          <ng-template #noHours>-</ng-template>

          <div class="mt-1 font-medium">{{ (lang$ | async) === 'TC' ? '座位' : 'Seats' }}</div>
          <div>{{ restaurant?.Seats ?? '-' }}</div>
        </div>
      </ion-col>

      <!-- 2 Map: double-click to open fullscreen -->
      <ion-col class="cell no-border" size="12" size-md="4">
        <div class="cell-title">
          <ion-icon name="map-outline"></ion-icon>
          &nbsp;{{ (lang$ | async) === 'TC' ? '地圖' : 'Map' }}
        </div>
        <div class="cell-content">
          <div *ngIf="hasCoordinates(); else coordsOnly">
            <div id="restaurant-map" class="map-container" (dblclick)="openMapModal()" (touchend)="onMapTouchEnd()" tabindex="0" role="button" aria-label="Open map fullscreen"></div>
            <div class="muted small mt-1">
              <a *ngIf="hasCoordinates()" target="_blank" rel="noopener noreferrer"
                 [href]="'https://www.google.com/maps/search/?api=1&query=' + restaurant?.Latitude + ',' + restaurant?.Longitude">
                {{ (lang$ | async) === 'TC' ? '在 Google 地圖開啟' : 'Open in Google Maps' }}
              </a>
            </div>
            <div class="hint small muted">Double-click to view fullscreen</div>
          </div>
          <ng-template #coordsOnly>
            <div class="muted small">
              {{ restaurant ? (restaurant.Latitude != null ? restaurant.Latitude : '-') : '-' }},
              {{ restaurant ? (restaurant.Longitude != null ? restaurant.Longitude : '-') : '-' }}
            </div>
          </ng-template>
        </div>
      </ion-col>

      <!-- 3 Booking: date + time + guests + special requests -->
      <ion-col class="cell no-border" size="12" size-md="4">
        <div class="cell-title">
          <ion-icon name="calendar-outline"></ion-icon>
          &nbsp;{{ (lang$ | async) === 'TC' ? '預約' : 'Booking' }}
        </div>
        <div class="cell-content small">
          <div class="booking-stack" [class.dark]="(isDark$ | async)" [class.force-calendar-light-in-dark]="(isDark$ | async)">
            <!-- Date and time picker -->
            <ion-datetime display-format="YYYY-MM-DD HH:mm"
                          picker-format="YYYY-MM-DD HH:mm"
                          presentation="date-time"
                          [(ngModel)]="bookingDateTime"
                          [color]="(isDark$ | async) ? 'dark' : 'primary'"
                          class="booking-datetime"
                          [min]="minBookingDate"
                          aria-label="Booking date and time">
            </ion-datetime>

            <!-- Guest number selection -->
            <div class="guest-selection mt-1">
              <ion-item lines="none" class="guest-item">
                <ion-icon name="people-outline" slot="start"></ion-icon>
                <ion-label>{{ (lang$ | async) === 'TC' ? '人數' : 'Guests' }}</ion-label>
                <ion-select [(ngModel)]="numberOfGuests" interface="popover" class="guest-select">
                  <ion-select-option *ngFor="let num of guestOptions" [value]="num">
                    {{ num }} {{ (lang$ | async) === 'TC' ? '位' : (num === 1 ? 'guest' : 'guests') }}
                  </ion-select-option>
                </ion-select>
              </ion-item>
            </div>

            <!-- Special requests input -->
            <div class="special-requests mt-1">
              <ion-item lines="none" class="requests-item">
                <ion-icon name="chatbubble-outline" slot="start"></ion-icon>
                <ion-textarea [(ngModel)]="specialRequests"
                              [placeholder]="(lang$ | async) === 'TC' ? '特別要求（可選）' : 'Special requests (optional)'"
                              rows="2"
                              class="requests-textarea">
                </ion-textarea>
              </ion-item>
            </div>

            <!-- Booking actions -->
            <div class="booking-actions mt-1">
              <div class="datetime-row">
                <span class="muted small">{{ bookingDateTime ? bookingDateTime : ((lang$ | async) === 'TC' ? '請選擇日期時間' : 'Select date & time') }}</span>
                <ion-button fill="solid" size="medium" style="margin-right: 2vw;" (click)="onBook()" [disabled]="!bookingDateTime || isBookingLoading">
                  <ion-spinner name="crescent" *ngIf="isBookingLoading" slot="start"></ion-spinner>
                  <ion-icon slot="start" name="calendar-number-outline" *ngIf="!isBookingLoading"></ion-icon>
                  {{ (lang$ | async) === 'TC' ? '確定預約' : 'Confirm' }}
                </ion-button>
              </div>
            </div>
          </div>
        </div>
      </ion-col>

      <!-- 4 Contacts: use icons for phone, email, website -->
      <ion-col class="cell no-border" size="12" size-md="4">
        <div class="cell-title">
          <ion-icon name="person-outline"></ion-icon>
          &nbsp;{{ (lang$ | async) === 'TC' ? '聯絡方式' : 'Contacts' }}
        </div>
        <div class="cell-content small">
          <div>
            <ion-icon name="call-sharp"></ion-icon>
            &nbsp;{{ restaurant?.Contacts?.Phone ?? '-' }}
          </div>
          <div>
            <ion-icon name="mail-outline"></ion-icon>
            &nbsp;{{ restaurant?.Contacts?.Email ?? '-' }}
          </div>
          <div *ngIf="restaurant?.Contacts?.Website; else noWebsiteSmall">
            <ion-icon name="globe-outline"></ion-icon>
            &nbsp;<a target="_blank" rel="noopener noreferrer" [href]="restaurant?.Contacts?.Website">{{ restaurant?.Contacts?.Website }}</a>
          </div>
          <ng-template #noWebsiteSmall>-</ng-template>
        </div>
      </ion-col>

      <!-- 5 Keywords -->
      <ion-col class="cell no-border" size="12" size-md="4">
        <div class="cell-title">
          <ion-icon name="pricetag-outline"></ion-icon>
          &nbsp;{{ (lang$ | async) === 'TC' ? '關鍵字' : 'Keywords' }}
        </div>
        <div class="cell-content small">
          <ng-container *ngIf="(lang$ | async) === 'TC'; else enList">
            <div *ngFor="let k of (restaurant?.Keyword_TC ?? [])">{{ k }}</div>
            <div *ngIf="!(restaurant?.Keyword_TC?.length) && !(restaurant?.Keyword_EN?.length)">-</div>
          </ng-container>
          <ng-template #enList>
            <div *ngFor="let k of (restaurant?.Keyword_EN ?? [])">{{ k }}</div>
            <div *ngIf="!(restaurant?.Keyword_EN?.length) && !(restaurant?.Keyword_TC?.length)">-</div>
          </ng-template>
        </div>
      </ion-col>

      <!-- 6 Menu: double-click to open fullscreen -->
      <ion-col class="cell no-border" size="12" size-md="4">
        <div class="cell-title">
          <ion-icon name="restaurant-outline"></ion-icon>
          &nbsp;{{ (lang$ | async) === 'TC' ? '餐牌' : 'Menu' }}
        </div>
        <div class="cell-content small">
          <div *ngIf="(restaurant?.Menu ?? []).length > 0; else noMenuSmall">
            <ion-list lines="none">
              <ion-item *ngFor="let menuItem of (restaurant?.Menu ?? [])" (dblclick)="openMenuModal()" (touchend)="onMenuItemTouchEnd()">
                <ion-label>
                  <div class="font-medium">
                    {{ (lang$ | async) === 'TC' ? (menuItem?.Name_TC ?? menuItem?.Name_EN ?? '-') : (menuItem?.Name_EN ?? menuItem?.Name_TC ?? '-') }}
                  </div>
                  <div class="muted small">{{ (menuItem?.Price != null) ? ('$' + menuItem.Price) : '-' }}</div>
                </ion-label>
              </ion-item>
            </ion-list>
            <div class="hint small muted">Double-click any item to view menu fullscreen</div>
          </div>
          <ng-template #noMenuSmall>-</ng-template>
        </div>
      </ion-col>
    </ion-row>
  </ion-grid>

  <!-- Reserve review spot below -->
  <ion-grid class="review-grid ion-no-padding">
    <ion-row>
      <ion-col size="12">
        <div class="section-header">
          <ion-icon name="create-outline"></ion-icon>
          &nbsp;{{ (lang$ | async) === 'TC' ? '撰寫食評' : 'Write a Review' }}
        </div>
        <div class="review-spot">
          <div class="small muted">{{ (lang$ | async) === 'TC' ? '預留一個空位以稍後撰寫食評。' : 'Reserve a spot to write a review later.' }}</div>
          <div class="mt-1">
            <ion-button fill="outline" size="small" (click)="reserveReviewSpot()">
              <ion-icon slot="start" name="timer-outline"></ion-icon>
              {{ (lang$ | async) === 'TC' ? '預留' : 'Reserve' }}
            </ion-button>
            <ion-button fill="solid" size="small" (click)="startReviewNow()">
              <ion-icon slot="start" name="chatbox-ellipses-outline"></ion-icon>
              {{ (lang$ | async) === 'TC' ? '立即撰寫' : 'Write Now' }}
            </ion-button>
          </div>
        </div>
      </ion-col>
    </ion-row>
  </ion-grid>
  <br>
  <!-- Pull-to-refresh -->
  <ion-refresher slot="fixed" (ionRefresh)="ngAfterViewInit()" pullFactor="0.5">
    <ion-refresher-content></ion-refresher-content>
  </ion-refresher>

  <!-- Loading and error states -->
  <ion-loading [isOpen]="isLoading" message="Loading..."></ion-loading>
  <ion-toast *ngIf="errorMessage" [message]="errorMessage" duration="3000"></ion-toast>
</ion-content>