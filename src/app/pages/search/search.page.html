<!-- Search page UI: bilingual search, district select, veggie/vegan quick filters -->
<ion-content class="search-page-content">
  <ng-container *ngIf="isMobile$ | async as isMobile">
  <div class="page-container" [class.mobile-layout]="isMobile" [class.web-layout]="!isMobile">

    <!-- Page Title (Non-sticky) -->
    <div class="search-title-container">
      <h1 class="page-title">
        {{ (lang$ | async) === 'TC' ? translations.searchTitle.TC : translations.searchTitle.EN }}
      </h1>
      <p class="page-subtitle">
        {{ (lang$ | async) === 'TC' ? translations.searchSubtitle.TC : translations.searchSubtitle.EN }}
      </p>
    </div>

    <!-- Sticky Search & Filter Section -->
    <div class="search-header">
      <!-- Search Bar -->
      <div class="search-bar-container">
        <ion-searchbar [(ngModel)]="searchQuery"
                       (ionInput)="onSearchInput()"
                       [placeholder]="(lang$ | async) === 'TC' ? translations.searchPlaceholder.TC : translations.searchPlaceholder.EN"
                       [debounce]="300"
                       animated
                       class="search-bar">
        </ion-searchbar>
      </div>

      <!-- Filter Chips -->
      <div class="filter-section">
        <div class="filter-chips-container">
          <!-- District Filter Button -->
          <ion-chip [outline]="selectedDistrictTokens.length === 0"
                    [color]="selectedDistrictTokens.length > 0 ? 'primary' : 'medium'"
                    (click)="openDistrictFilter()"
                    class="filter-chip filter-button">
            <ion-icon name="location-outline"></ion-icon>
            <ion-label>
              {{ selectedDistrictTokens.length > 0
                 ? ((lang$ | async) === 'TC' ? '地區' : 'Districts')
                 : ((lang$ | async) === 'TC' ? translations.allDistricts.TC : translations.allDistricts.EN) }}
            </ion-label>
            <ion-icon name="close-circle" *ngIf="selectedDistrictTokens.length > 0" (click)="clearDistrict($event)"></ion-icon>
          </ion-chip>

          <!-- District Tags -->
          <ion-chip *ngFor="let district of selectedDistrictTokens"
                    color="primary"
                    class="filter-tag">
            <ion-label>{{ getDistrictLabel(district) }}</ion-label>
            <ion-icon name="close-circle" (click)="removeDistrictTag(district, $event)"></ion-icon>
          </ion-chip>

          <!-- Keyword Filter Button -->
          <ion-chip [outline]="selectedKeywordTokens.length === 0"
                    [color]="selectedKeywordTokens.length > 0 ? 'primary' : 'medium'"
                    (click)="openKeywordFilter()"
                    class="filter-chip filter-button">
            <ion-icon name="pricetag-outline"></ion-icon>
            <ion-label>
              {{ selectedKeywordTokens.length > 0
                 ? ((lang$ | async) === 'TC' ? '分類' : 'Categories')
                 : ((lang$ | async) === 'TC' ? translations.allCategories.TC : translations.allCategories.EN) }}
            </ion-label>
            <ion-icon name="close-circle" *ngIf="selectedKeywordTokens.length > 0" (click)="clearKeyword($event)"></ion-icon>
          </ion-chip>

          <!-- Keyword Tags -->
          <ion-chip *ngFor="let keyword of selectedKeywordTokens"
                    color="primary"
                    class="filter-tag">
            <ion-label>{{ getKeywordLabel(keyword) }}</ion-label>
            <ion-icon name="close-circle" (click)="removeKeywordTag(keyword, $event)"></ion-icon>
          </ion-chip>

          <!-- Clear All Filters Button -->
          <ion-chip *ngIf="selectedDistrictTokens.length > 0 || selectedKeywordTokens.length > 0"
                    color="danger"
                    (click)="clearAllFilters()"
                    class="filter-chip clear-chip">
            <ion-icon name="close-outline"></ion-icon>
            <ion-label>{{ (lang$ | async) === 'TC' ? translations.clearFilters.TC : translations.clearFilters.EN }}</ion-label>
          </ion-chip>
        </div>
      </div>
    </div>

    <!-- Results Summary -->
    <div class="results-summary" *ngIf="!isLoading">
      <p class="results-count">
        <span class="count-number">{{ totalResults }}</span>
        {{ (lang$ | async) === 'TC' ? translations.restaurantsFound.TC : translations.restaurantsFound.EN }}
      </p>
    </div>

    <!-- Loading State -->
    <div class="loading-container" *ngIf="isLoading">
      <img src="assets/icon/Eclipse.gif" alt="Loading" class="loading-spinner">
      <p>{{ (lang$ | async) === 'TC' ? translations.loading.TC : translations.loading.EN }}</p>
    </div>

    <!-- No Results State -->
    <div class="empty-state" *ngIf="!isLoading && restaurants.length === 0">
      <ion-icon name="search-outline" class="empty-icon"></ion-icon>
      <h2>{{ (lang$ | async) === 'TC' ? translations.noResults.TC : translations.noResults.EN }}</h2>
      <p>{{ (lang$ | async) === 'TC' ? translations.tryDifferent.TC : translations.tryDifferent.EN }}</p>
      <ion-button fill="outline" (click)="clearAllFilters()" *ngIf="selectedDistrict || selectedKeyword || searchQuery">
        {{ (lang$ | async) === 'TC' ? translations.clearFilters.TC : translations.clearFilters.EN }}
      </ion-button>
    </div>

    <!-- Restaurant Results Grid -->
    <div class="results-grid" *ngIf="!isLoading && restaurants.length > 0">
      <ion-card *ngFor="let restaurant of restaurants"
                class="restaurant-card"
                [routerLink]="['/restaurant', restaurant.id]"
                button>

        <!-- Restaurant Image -->
        <div class="card-image-container">
          <img [src]="restaurant.ImageUrl || 'assets/icon/Placeholder.png'"
               [alt]="(lang$ | async) === 'TC' ? restaurant.Name_TC : restaurant.Name_EN"
               class="restaurant-image">
          <div class="image-overlay"></div>
        </div>

        <!-- Restaurant Info -->
        <ion-card-content class="card-content">
          <h3 class="restaurant-name">
            {{ (lang$ | async) === 'TC' ? restaurant.Name_TC : restaurant.Name_EN }}
          </h3>

          <div class="restaurant-details">
            <div class="detail-row" *ngIf="restaurant.District_EN || restaurant.District_TC">
              <ion-icon name="location-outline" class="detail-icon"></ion-icon>
              <span class="detail-text">
                {{ (lang$ | async) === 'TC' ? restaurant.District_TC : restaurant.District_EN }}
              </span>
            </div>

            <div class="detail-row" *ngIf="restaurant.Address_EN || restaurant.Address_TC">
              <ion-icon name="navigate-outline" class="detail-icon"></ion-icon>
              <span class="detail-text">
                {{ (lang$ | async) === 'TC' ? restaurant.Address_TC : restaurant.Address_EN }}
              </span>
            </div>

            <div class="detail-row" *ngIf="restaurant.Keyword_EN?.length || restaurant.Keyword_TC?.length">
              <ion-icon name="pricetag-outline" class="detail-icon"></ion-icon>
              <div class="keywords-container">
                <ion-chip *ngFor="let keyword of getDisplayKeywords(restaurant); let i = index"
                          class="keyword-chip"
                          [class.hidden]="i >= 2">
                  {{ keyword }}
                </ion-chip>
                <ion-chip *ngIf="getKeywordCount(restaurant) > 2"
                          class="keyword-chip more-chip">
                  +{{ getKeywordCount(restaurant) - 2 }}
                </ion-chip>
              </div>
            </div>
          </div>
        </ion-card-content>
      </ion-card>
    </div>

    <!-- Infinite Scroll -->
    <ion-infinite-scroll
      *ngIf="!isLoading && restaurants.length > 0 && currentPage < totalPages - 1"
      threshold="15%"
      (ionInfinite)="loadMore($event)">
      <ion-infinite-scroll-content
        loadingSpinner="null"
        [loadingText]="(lang$ | async) === 'TC' ? '載入更多...' : 'Loading more...'">
        <div class="infinite-scroll-loading">
          <img src="assets/icon/Eclipse.gif" alt="Loading" class="loading-spinner-small">
          <span>{{ (lang$ | async) === 'TC' ? '載入更多...' : 'Loading more...' }}</span>
        </div>
      </ion-infinite-scroll-content>
    </ion-infinite-scroll>

    <!-- Bottom Spacer -->
    <div class="bottom-spacer"></div>
  </div>
  </ng-container>
</ion-content>