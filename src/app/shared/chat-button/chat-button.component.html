<!-- Floating chat button (hidden when Gemini is open) -->
<div class="chat-fab" [class.open]="isOpen" [class.hidden]="geminiButtonOpen$ | async" (click)="toggleChat()">
  <div class="chat-icon-wrapper">
    <ion-icon name="chatbubbles" class="chat-icon"></ion-icon>
  </div>
  <span class="chat-label" *ngIf="!isOpen">{{ (lang$ | async) === 'TC' ? '聊天' : 'Chat' }}</span>
  <span class="unread-badge" *ngIf="unreadCount > 0 && !isOpen">{{ unreadCount }}</span>
</div>

<!-- Chat window -->
<div class="chat-window" [class.open]="isOpen">
  <!-- Chat header -->
  <div class="chat-header">
    <div class="chat-header-content">
      <ion-icon name="restaurant" class="restaurant-icon"></ion-icon>
      <div class="chat-header-text">
        <h3>{{ restaurantName }}</h3>
        <p class="connection-status">
          <span class="status-dot" [class.connected]="isConnected"></span>
          <ng-container *ngIf="lang$ | async as lang">
            {{ isConnected ? (lang === 'TC' ? '線上' : 'Online') : (lang === 'TC' ? '離線' : 'Offline') }}
          </ng-container>
        </p>
      </div>
    </div>
    <ion-icon name="close" class="close-icon" (click)="toggleChat()"></ion-icon>
  </div>

  <!-- Chat messages -->
  <div class="chat-messages">
    <!-- Login prompt -->
    <div *ngIf="showLoginPrompt" class="login-prompt">
      <ion-icon name="lock-closed" class="login-icon"></ion-icon>
      <h3 *ngIf="lang$ | async as lang">
        {{ lang === 'TC' ? '需要登入' : 'Login Required' }}
      </h3>
      <p *ngIf="lang$ | async as lang">
        {{ lang === 'TC' ? '請登入以與餐廳擁有者聊天' : 'Please login to chat with the restaurant owner' }}
      </p>
      <ion-button expand="block" (click)="goToLogin()">
        <ion-icon name="log-in-outline" slot="start"></ion-icon>
        {{ (lang$ | async) === 'TC' ? '前往登入' : 'Go to Login' }}
      </ion-button>
    </div>

    <!-- Loading history -->
    <div *ngIf="!showLoginPrompt && isLoadingHistory" class="loading-state">
      <ion-spinner name="crescent"></ion-spinner>
      <p *ngIf="lang$ | async as lang">
        {{ lang === 'TC' ? '載入對話記錄...' : 'Loading chat history...' }}
      </p>
    </div>

    <!-- Empty state -->
    <div *ngIf="!showLoginPrompt && !isLoadingHistory && messages.length === 0" class="empty-state">
      <ion-icon name="chatbubbles-outline" class="empty-icon"></ion-icon>
      <p *ngIf="lang$ | async as lang">
        {{ lang === 'TC' ? '開始對話' : 'Start a conversation' }}
      </p>
    </div>

    <!-- messages -->
    <ng-container *ngIf="!showLoginPrompt && !isLoadingHistory">
      <div *ngFor="let message of messages"
           class="message"
           [class.own]="isOwnMessage(message)">
        <div class="message-content">
          <span class="message-author" *ngIf="!isOwnMessage(message)">{{ message.displayName }}</span>

          <!-- Image message -->
          <a *ngIf="hasImage(message)"
             [href]="getImageUrl(message)"
             [attr.data-pswp-width]="800"
             [attr.data-pswp-height]="600"
             class="message-image-link"
             target="_blank">
            <img [src]="getImageUrl(message)"
                 alt="Image"
                 class="message-image"
                 loading="lazy" />
          </a>

          <!-- Text message (hidden if only contains Firebase Storage URL) -->
          <p class="message-text" *ngIf="shouldShowMessageText(message)">{{ message.message }}</p>
          <span class="message-time">{{ formatTime(message.timestamp) }}</span>
        </div>
      </div>
    </ng-container>

    <!-- Typing indicator -->
    <div *ngIf="!showLoginPrompt && !isLoadingHistory && isTyping" class="typing-indicator">
      <ion-icon name="chatbox-ellipses-sharp" class="typing-icon"></ion-icon>
      <span class="typing-text">{{ (lang$ | async) === 'TC' ? '正在輸入...' : 'Typing...' }}</span>
    </div>
  </div>

  <!-- Chat input -->
  <div class="chat-input" *ngIf="!showLoginPrompt">
    <!-- Image preview -->
    <div class="image-preview-container" *ngIf="previewUrl">
      <div class="image-preview">
        <img [src]="previewUrl" alt="Preview" />
        <button class="remove-image" (click)="clearImage()">
          <ion-icon name="close-circle"></ion-icon>
        </button>
      </div>
      <div class="upload-progress" *ngIf="isUploadingImage">
        <div class="progress-bar" [style.width.%]="uploadProgress"></div>
      </div>
    </div>

    <div class="input-row">
      <!-- Image upload button -->
      <button class="image-button"
              (click)="selectImage()"
              [disabled]="!isConnected || isUploadingImage"
              type="button">
        <ion-icon name="image"></ion-icon>
      </button>

      <!-- Hidden file input -->
      <input #fileInput
             type="file"
             accept="image/*"
             (change)="onImageSelected($event)"
             style="display: none;" />

      <!-- Text input -->
      <textarea [(ngModel)]="newMessage"
                (input)="onTyping()"
                (keydown.enter)="$event.preventDefault(); sendMessage()"
                [placeholder]="(lang$ | async) === 'TC' ? '輸入訊息...' : 'Type a message...'"
                rows="1"
                [disabled]="!isConnected || isUploadingImage">
      </textarea>

      <!-- Send button -->
      <button (click)="sendMessage()"
              [disabled]="(!newMessage.trim() && !selectedImage) || !isConnected || isUploadingImage"
              class="send-button"
              type="button">
        <ion-icon [name]="isUploadingImage ? 'hourglass' : 'send'"></ion-icon>
      </button>
    </div>
  </div>
</div>