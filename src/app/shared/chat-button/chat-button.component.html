<!-- Floating chat button -->
<div class="chat-fab" [class.open]="isOpen" (click)="toggleChat()">
  <div class="chat-icon-wrapper">
    <ion-icon name="chatbubbles" class="chat-icon"></ion-icon>
  </div>
  <span class="chat-label" *ngIf="!isOpen">{{ (lang$ | async) === 'TC' ? '聊天' : 'Chat' }}</span>
  <span class="unread-badge" *ngIf="unreadCount > 0 && !isOpen">{{ unreadCount }}</span>
</div>

<!-- Chat window -->
<div class="chat-window" [class.open]="isOpen">
  <!-- Chat header -->
  <div class="chat-header">
    <div class="chat-header-content">
      <ion-icon name="restaurant" class="restaurant-icon"></ion-icon>
      <div class="chat-header-text">
        <h3>{{ restaurantName }}</h3>
        <p class="connection-status">
          <span class="status-dot" [class.connected]="isConnected"></span>
          <ng-container *ngIf="lang$ | async as lang">
            {{ isConnected ? (lang === 'TC' ? '線上' : 'Online') : (lang === 'TC' ? '離線' : 'Offline') }}
          </ng-container>
        </p>
      </div>
    </div>
    <ion-icon name="close" class="close-icon" (click)="toggleChat()"></ion-icon>
  </div>

  <!-- Chat messages -->
  <div class="chat-messages">
    <!-- Login prompt -->
    <div *ngIf="showLoginPrompt" class="login-prompt">
      <ion-icon name="lock-closed" class="login-icon"></ion-icon>
      <h3 *ngIf="lang$ | async as lang">
        {{ lang === 'TC' ? '需要登入' : 'Login Required' }}
      </h3>
      <p *ngIf="lang$ | async as lang">
        {{ lang === 'TC' ? '請登入以與餐廳擁有者聊天' : 'Please login to chat with the restaurant owner' }}
      </p>
      <ion-button expand="block" (click)="goToLogin()">
        <ion-icon name="log-in-outline" slot="start"></ion-icon>
        {{ (lang$ | async) === 'TC' ? '前往登入' : 'Go to Login' }}
      </ion-button>
    </div>

    <div *ngIf="!showLoginPrompt && messages.length === 0" class="empty-state">
      <ion-icon name="chatbubbles-outline" class="empty-icon"></ion-icon>
      <p *ngIf="lang$ | async as lang">
        {{ lang === 'TC' ? '開始對話' : 'Start a conversation' }}
      </p>
    </div>

    <div
      *ngIf="!showLoginPrompt"
      *ngFor="let message of messages"
      class="message"
      [class.own]="isOwnMessage(message)"
    >
      <div class="message-content">
        <span class="message-author" *ngIf="!isOwnMessage(message)">{{ message.displayName }}</span>
        <p class="message-text">{{ message.message }}</p>
        <span class="message-time">{{ formatTime(message.timestamp) }}</span>
      </div>
    </div>

    <div *ngIf="!showLoginPrompt && isTyping" class="typing-indicator">
      <ion-icon name="chatbox-ellipses-sharp" class="typing-icon"></ion-icon>
      <span class="typing-text">{{ (lang$ | async) === 'TC' ? '正在輸入...' : 'Typing...' }}</span>
    </div>
  </div>

  <!-- Chat input -->
  <div class="chat-input" *ngIf="!showLoginPrompt">
    <textarea
      [(ngModel)]="newMessage"
      (input)="onTyping()"
      (keydown.enter)="$event.preventDefault(); sendMessage()"
      [placeholder]="(lang$ | async) === 'TC' ? '輸入訊息...' : 'Type a message...'"
      rows="1"
      [disabled]="!isConnected"
    ></textarea>
    <button
      (click)="sendMessage()"
      [disabled]="!newMessage.trim() || !isConnected"
      class="send-button"
    >
      <ion-icon name="send"></ion-icon>
    </button>
  </div>
</div>
